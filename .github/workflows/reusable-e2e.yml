name: E2E
on:
  workflow_call:
    inputs:
      dist-artifact-name:
        required: true
        type: string
      ref:
        description: Git reference to checkout. Defaults to @actions/checkout default.
        type: string
        required: false
        default: ''

env:
  E2E_DIR: projects/ngx-meta/e2e
  SOURCE_MAP_EXPLORER_ARTIFACT_NAME_PREFIX: ngx-meta-source-map-explorer-a
  BUNDLE_SIZE_COMMENT_ID_PREFIX: bundle-size-comment-a
  BUNDLE_SIZE_CHECK_RUN_NAME_PREFIX: ngx-meta-bundle-size-a

#permissions:
#  ðŸ‘‡ Needed for PR bundle size comment only
#  pull_requests: write
#  ðŸ‘‡ Needed for main bundle size check store only
#  checks: write

jobs:
  e2e:
    name: E2E tests - Angular v${{ matrix.version }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        version: [15, 16, 17]
    env:
      E2E_APP_DIR: projects/ngx-meta/e2e/a${{ matrix.version }}
    defaults:
      run:
        working-directory: ${{ env.E2E_APP_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          ref: ${{ inputs.ref }}
      - name: Download distribution files
        uses: actions/download-artifact@eaceaf801fd36c7dee90939fad912460b18a1ffe # v4
        with:
          name: ${{ inputs.dist-artifact-name }}
          path: 'projects/ngx-meta/dist'
      - name: Setup pnpm
        uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4
        with:
          cache: 'pnpm'
          cache-dependency-path: |
            ${{ env.E2E_DIR }}/pnpm-lock.yaml
            ${{ env.E2E_APP_DIR }}/pnpm-lock.yaml
          node-version-file: '.node-version'
      - name: Install Angular v${{ matrix.version }} E2E app dependencies
        run: pnpm install --frozen-lockfile
      - name: Build Angular v${{ matrix.version }} E2E app
        run: pnpm build:source-map # with source map for bundle size job!
      - name: Start Angular v${{ matrix.version }} E2E app server
        run: pnpm start &
      - name: Cypress run
        uses: cypress-io/github-action@1b70233146622b69e789ccdd4f9452adc638d25a # v6.6.1
        with:
          wait-on: 'http://localhost:4200'
          working-directory: ${{ env.E2E_DIR }}
          browser: chrome
      - name: Analyze main bundle with source map explorer
        run: pnpm run source-map-explorer-json
      - name: Upload main bundle analysis results
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4
        with:
          name: ${{ env.SOURCE_MAP_EXPLORER_ARTIFACT_NAME_PREFIX }}${{ matrix.version }}
          path: |
            ${{ env.E2E_APP_DIR }}/source-map-explorer.json
          retention-days: 5
  bundle-size-pr-comment:
    needs: e2e
    if: github.event_name == 'pull_request'
    name: Bundle size PR comment - Angular v${{ matrix.version }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        version: [15, 16, 17]
    env:
      E2E_APP_DIR: projects/ngx-meta/e2e/a${{ matrix.version }}
    defaults:
      run:
        working-directory: ${{ env.E2E_APP_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          ref: ${{ inputs.ref }}
      - name: Download main bundle analysis results
        uses: actions/download-artifact@eaceaf801fd36c7dee90939fad912460b18a1ffe # v4
        with:
          name: ${{ env.SOURCE_MAP_EXPLORER_ARTIFACT_NAME_PREFIX }}${{ matrix.version }}
          path: ${{ env.E2E_APP_DIR }}
      - name: Fetch main bundle analysis results from 'main' branch
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const checkRunResponse = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main',
              check_name: '${{ env.BUNDLE_SIZE_CHECK_RUN_NAME_PREFIX }}${{ matrix.version }}',
              per_page: 1,
            })
            const checkRuns = checkRunResponse.data.check_runs
            if (checkRuns.length < 1) {
              console.info('No check runs found')
              return
            }
            const checkRun = checkRuns[0]
            const smeJsonString = checkRun.output.text
            const fs = require('fs')
            fs.writeFileSync('./source-map-explorer.json', smeJsonString)
      - name: Generate PR comment content
        run: |
          npm run bundle-pr-comment -- \
            --git-ref '${{ github.event.pull_request.head.sha }}' \
            --hidden-info '${{ env.BUNDLE_SIZE_COMMENT_ID_PREFIX }}${{ matrix.version }}' \
            --base-file '../../../../source-map-explorer.json'
      - name: Find bundle size PR comment
        uses: peter-evans/find-comment@d5fe37641ad8451bdd80312415672ba26c86575e # v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: ${{ env.BUNDLE_SIZE_COMMENT_ID_PREFIX }}${{ matrix.version }}
      - name: Update bundle size PR comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: ${{ env.E2E_APP_DIR }}/bundle-size-pr-comment.md
          edit-mode: replace
  bundle-size-store:
    needs: e2e
    if: github.event_name == 'push'
    name: Bundle size store - Angular v${{ matrix.version }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        version: [15, 16, 17]
    steps:
      - name: Download main bundle analysis results
        uses: actions/download-artifact@eaceaf801fd36c7dee90939fad912460b18a1ffe # v4
        with:
          name: ${{ env.SOURCE_MAP_EXPLORER_ARTIFACT_NAME_PREFIX }}${{ matrix.version }}
      - name: Create check run
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const smeJson = require('./source-map-explorer.json');
            const smeJsonString = JSON.stringify(smeJson);
            return github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: '${{ env.BUNDLE_SIZE_CHECK_RUN_NAME_PREFIX }}${{ matrix.version }}',
              head_sha: context.sha,
              // In case you're testing this in a PR, you'll want the head SHA
              // otherwise, `context.sha` refers to the GitHub PR merge branch
              // which is a detail hidden away from users. Uncomment ðŸ‘‡
              // head_sha: '${{ github.event.pull_request.head.sha }}',
              conclusion: 'neutral',
              output: {
                title: 'Bundle size - Angular v${{ matrix.version }}',
                summary: 'Sizes of the library modules when packed inside a ' +
                         'main bundle of an Angular v${{ matrix.version }} ' +
                         'app. In bytes. Thanks to `source-map-explorer` :)',
                text: smeJsonString,
              }
            })
