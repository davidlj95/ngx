name: Coverage
on:
  workflow_call:
    secrets:
      codecov-token:
        description: Token to use to upload coverage to Codecov. Can be empty for forks https://about.codecov.io/blog/january-product-update-updating-the-codecov-ci-uploaders-to-the-codecov-cli/
        required: true

env:
  COVERAGE_DIR: coverage
  # ðŸ‘‡ Keep in sync with e2e and coverage workflows
  COVERAGE_REPORT_ARTIFACT_NAME_SUFFIX: -coverage-report

permissions:
  contents: none

jobs:
  upload-to-codecov:
    name: Upload to Codecov
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Setup
        uses: ./.github/actions/setup
      - name: Download coverage reports
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          pattern: '*${{ env.COVERAGE_REPORT_ARTIFACT_NAME_SUFFIX }}'
          path: ${{ env.COVERAGE_DIR }}
          merge-multiple: true
      - name: Merge coverage reports
        run: pnpm run coverage:report:all
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@18283e04ce6e62d37312384ff67231eb8fd56d24 # v5.4.3
        with:
          disable_search: true
          files: ${{ env.COVERAGE_DIR }}/lcov.info
          token: ${{ secrets.codecov-token }}
